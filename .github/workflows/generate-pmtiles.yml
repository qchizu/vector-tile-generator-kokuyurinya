# ワークフロー名の定義
name: Generate PMTiles

# ワークフローのトリガー条件
on:
  # data/sourceディレクトリ内のファイルが変更された場合に実行
  push:
    paths:
      - 'data/source/**'
  # 手動実行を可能にする
  workflow_dispatch:
    inputs:
      # 実験用の設定名を指定可能
      experiment_name:
        description: 'Name for this experimental configuration'
        required: false
        type: string
      # 本番リリースとしてマークするかどうか
      production_release:
        description: 'Mark this as a production release'
        required: false
        type: boolean
        default: false
      # 本番リリース時のバージョンタグ
      version_tag:
        description: 'Version tag for production release (e.g., v1.0.0)'
        required: false
        type: string

# 環境変数の設定
# タイムスタンプは各ステップで使用される
env:
  TIMESTAMP: $(date +'%Y%m%d_%H%M%S')

# ジョブの定義
jobs:
  build:
    runs-on: ubuntu-latest
    # GitHub Pages等への書き込み権限を設定
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      # リポジトリのチェックアウト
      - uses: actions/checkout@v4

      # GDALのインストール（地理空間データ処理用）
      - name: Setup GDAL
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin

      # tippecanoe（ベクトルタイル生成ツール）のインストール
      - name: Setup tippecanoe
        run: |
          git clone https://github.com/felt/tippecanoe.git
          cd tippecanoe
          make -j
          sudo make install

      # 必要なディレクトリ構造の作成
      - name: Create directory structure
        run: |
          mkdir -p data/processed
          mkdir -p experiments
          mkdir -p production/releases
          mkdir -p _site/tiles/{experiments,releases}

      # タイムスタンプの設定
      # GitHub Actions環境で正しく評価されるように環境変数として設定
      - name: Set timestamp
        run: |
          echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV

      # 入力GeoJSONファイルの結合
      - name: Merge GeoJSON files
        run: |
          python3 $(which ogrmerge.py) -single \
            -o data/processed/merged.geojson \
            data/source/*.geojson || echo "No source files found"

      # 詳細レイヤーの生成（ズームレベル14）
      - name: Generate detail layer
        run: |
          tippecanoe -o data/processed/detail.mbtiles \
            -z14 -Z14 \
            --no-tile-size-limit --no-feature-limit \
            -l detail \
            data/processed/merged.geojson

      # 国有林名称レイヤーの生成（ズームレベル10-13）
      - name: Generate kokuyurinmeisho layer
        run: |
          # 属性でディゾルブ処理を実行
          ogr2ogr -f FlatGeobuf \
            data/processed/merged_kokuyurinmeisho_dissolved.fgb \
            data/processed/merged.geojson \
            -dialect sqlite \
            -sql "SELECT ST_Union(geometry) as geometry, A45_013, A45_024 FROM merged GROUP BY A45_013, A45_024"

          # ベクトルタイル生成
          tippecanoe -o data/processed/kokuyurinmeisho.mbtiles \
            -z13 -Z10 \
            --no-tile-size-limit --no-feature-limit \
            -l kokuyurinmeisho \
            --no-simplification-of-shared-nodes \
            --detect-shared-borders \
            data/processed/merged_kokuyurinmeisho_dissolved.fgb

      # 計画区名称レイヤーの生成（ズームレベル2-9）
      - name: Generate keikakukumeisho layer
        run: |
          # 属性でディゾルブ処理を実行
          ogr2ogr -f FlatGeobuf \
            data/processed/merged_keikakukumeisho_dissolved.fgb \
            data/processed/merged.geojson \
            -dialect sqlite \
            -sql "SELECT ST_Union(geometry) as geometry, A45_024 FROM merged GROUP BY A45_024"

          # ベクトルタイル生成
          tippecanoe -o data/processed/keikakukumeisho.mbtiles \
            -z9 -Z2 \
            --no-tile-size-limit --no-feature-limit \
            -l keikakukumeisho \
            --no-simplification-of-shared-nodes \
            --detect-shared-borders \
            data/processed/merged_keikakukumeisho_dissolved.fgb

      # タイルの結合とPMTilesの生成
      - name: Join tiles and generate PMTiles
        run: |
          # 出力ファイル名の設定
          OUTPUT_NAME="kokuyurinya_${{ env.TIMESTAMP }}.pmtiles"
          WORKFLOW_CONFIG_NAME="generate-pmtiles_${{ env.TIMESTAMP }}.yml"
          
          # タイルの結合
          tile-join -o "data/processed/$OUTPUT_NAME" \
            -n "国土数値情報 国有林野データ" \
            -A "<a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A45.html'>国土数値情報 国有林野データ</a>" \
            --overzoom \
            --no-tile-size-limit \
            data/processed/detail.mbtiles \
            data/processed/kokuyurinmeisho.mbtiles \
            data/processed/keikakukumeisho.mbtiles

          # 設定ファイルのコピー
          cp .github/workflows/generate-pmtiles.yml "data/processed/$WORKFLOW_CONFIG_NAME"

          # 実験用または本番用のディレクトリにファイルをコピー
          if [ "${{ github.event.inputs.experiment_name }}" != "" ]; then
            # 実験用の場合
            OUTPUT_DIR="experiments/${{ github.event.inputs.experiment_name }}/${{ env.TIMESTAMP }}"
            mkdir -p "$OUTPUT_DIR"
            cp "data/processed/$OUTPUT_NAME" "$OUTPUT_DIR/"
            cp "data/processed/$WORKFLOW_CONFIG_NAME" "$OUTPUT_DIR/"
            
            # GitHub Pages用のコピー
            mkdir -p "_site/tiles/experiments/${{ github.event.inputs.experiment_name }}"
            cp "data/processed/$OUTPUT_NAME" "_site/tiles/experiments/${{ github.event.inputs.experiment_name }}/"
            cp "data/processed/$WORKFLOW_CONFIG_NAME" "_site/tiles/experiments/${{ github.event.inputs.experiment_name }}/"
          elif [ "${{ github.event.inputs.production_release }}" = "true" ]; then
            # 本番リリースの場合
            OUTPUT_DIR="production/releases/${{ env.TIMESTAMP }}"
            mkdir -p "$OUTPUT_DIR"
            cp "data/processed/$OUTPUT_NAME" "$OUTPUT_DIR/"
            cp "data/processed/$WORKFLOW_CONFIG_NAME" "$OUTPUT_DIR/"
            
            # GitHub Pages用のコピー
            mkdir -p "_site/tiles/releases"
            cp "data/processed/$OUTPUT_NAME" "_site/tiles/releases/"
            cp "data/processed/$WORKFLOW_CONFIG_NAME" "_site/tiles/releases/"
            
            # 最新版へのシンボリックリンク作成
            ln -sf "releases/${{ env.TIMESTAMP }}/$OUTPUT_NAME" "production/latest.pmtiles"
            cp "data/processed/$OUTPUT_NAME" "_site/tiles/latest.pmtiles"
          fi

      # バージョン情報JSONファイルの生成（本番リリース時のみ）
      - name: Create version.json
        if: github.event.inputs.production_release == 'true'
        run: |
          cat > _site/tiles/version.json << EOF
          {
            "version": "${{ github.event.inputs.version_tag }}",
            "timestamp": "${{ env.TIMESTAMP }}",
            "filename": "kokuyurinya_${{ env.TIMESTAMP }}.pmtiles",
          }
          EOF

      # インデックスページの生成
      - name: Generate index page
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>PMTiles Hosting</title>
          </head>
          <body>
            <h1>PMTiles Hosting</h1>
            <h2>Latest Production Release</h2>
            <p>URL: <code>https://[username].github.io/[repo]/tiles/latest.pmtiles</code></p>
            
            <h2>All Releases</h2>
            <p>Directory: <code>https://[username].github.io/[repo]/tiles/releases/</code></p>
            
            <h2>Experiments</h2>
            <p>Directory: <code>https://[username].github.io/[repo]/tiles/experiments/</code></p>
            
            <h2>Version Info</h2>
            <p>JSON: <code>https://[username].github.io/[repo]/tiles/version.json</code></p>
          </body>
          </html>
          EOF

      # GitHub Pagesの設定
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # GitHub Pagesへのアップロード
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      # GitHub Pagesへのデプロイ
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # 変更のコミット
      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add experiments/
          git add production/
          
          # 本番リリース時にタグを作成
          if [ "${{ github.event.inputs.production_release }}" = "true" ]; then
            git tag "${{ github.event.inputs.version_tag }}"
          fi
          
          # コミットメッセージの作成
          COMMIT_MSG="Update PMTiles and configurations

          ${{ env.TIMESTAMP }}
          Configuration: ${{ env.CONFIG_DIR }}"
          
          if [ "${{ github.event.inputs.production_release }}" = "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}
          Production Release: ${{ github.event.inputs.version_tag }}"
          fi
          
          git commit -m "${COMMIT_MSG}" || echo "No changes to commit"
          
          git push --tags || echo "No tags to push"
          git push || echo "No changes to push"
