name: Generate PMTiles

on:
  push:
    paths:
      - 'data/source/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # GitHub Releasesへの書き込み権限を追加
      pages: write      # GitHub Pages への書き込み権限を追加
      id-token: write  # GitHub Pages のデプロイに必要
    steps:
      - uses: actions/checkout@v4

      - name: Setup GDAL
        run: |
          sudo apt-get update
          sudo apt-get install -y gdal-bin

      - name: Create necessary directories
        run: |
          mkdir -p data/processed
          mkdir -p experiments
          mkdir -p production/{latest,archive}
          mkdir -p _site/tiles

      - name: Setup tippecanoe
        run: |
          git clone https://github.com/felt/tippecanoe.git
          cd tippecanoe
          make -j
          sudo make install

      - name: Create necessary directories
        run: |
          mkdir -p data/processed
          mkdir -p experiments
          mkdir -p production/{latest,archive}

      - name: Merge GeoJSON files
        run: |
          python3 $(which ogrmerge.py) -single \
            -o data/processed/merged.geojson \
            data/source/*.geojson || echo "No source files found"

      - name: Generate detail layer
        run: |
          tippecanoe -o data/processed/detail.mbtiles \
            -z14 -Z14 \
            --no-tile-size-limit --no-feature-limit \
            -l detail \
            data/processed/merged.geojson

      - name: Generate kokuyurinmeisho layer
        run: |
          # ディゾルブ処理
          ogr2ogr -f FlatGeobuf \
            data/processed/merged_kokuyurinmeisho_dissolved.fgb \
            data/processed/merged.geojson \
            -dialect sqlite \
            -sql "SELECT ST_Union(geometry) as geometry, A45_013, A45_024 FROM merged GROUP BY A45_013, A45_024"

          # タイル化
          tippecanoe -o data/processed/kokuyurinmeisho.mbtiles \
            -z13 -Z10 \
            --no-tile-size-limit --no-feature-limit \
            -l kokuyurinmeisho \
            --no-simplification-of-shared-nodes \
            --detect-shared-borders \
            data/processed/merged_kokuyurinmeisho_dissolved.fgb

      - name: Generate keikakukumeisho layer
        run: |
          # ディゾルブ処理
          ogr2ogr -f FlatGeobuf \
            data/processed/merged_keikakukumeisho_dissolved.fgb \
            data/processed/merged.geojson \
            -dialect sqlite \
            -sql "SELECT ST_Union(geometry) as geometry, A45_024 FROM merged GROUP BY A45_024"

          # タイル化
          tippecanoe -o data/processed/keikakukumeisho.mbtiles \
            -z9 -Z2 \
            --no-tile-size-limit --no-feature-limit \
            -l keikakukumeisho \
            --no-simplification-of-shared-nodes \
            --detect-shared-borders \
            data/processed/merged_keikakukumeisho_dissolved.fgb

      - name: Join tiles
        run: |
          tile-join -o production/latest/kokuyurinya.pmtiles \
            -n "国土数値情報 国有林野データ 2019年度（令和元年度）版" \
            -A "<a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A45.html'>国土数値情報 国有林野データ</a>" \
            --overzoom \
            --no-tile-size-limit \
            data/processed/detail.mbtiles \
            data/processed/kokuyurinmeisho.mbtiles \
            data/processed/keikakukumeisho.mbtiles

      - name: Copy PMTiles to GitHub Pages directory
        run: |
          cp production/latest/kokuyurinya.pmtiles _site/tiles/
          
          # index.htmlの作成（CORS設定を含む）
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>PMTiles Hosting</title>
          </head>
          <body>
            <h1>PMTiles Hosting</h1>
            <p>PMTiles URL: <code>https://qchizu.github.io/polygon-pmtiles-generator/tiles/kokuyurinya.pmtiles</code></p>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Update README
        run: |
          # プルを実行して最新の変更を取得
          git pull origin main --rebase

          cat > README.md << EOF
          # Polygon PMTiles Generator

          ## PMTiles URL
          \`\`\`
          https://qchizu.github.io/polygon-pmtiles-generator/tiles/kokuyurinya.pmtiles
          \`\`\`

          ## データの出典
          [国土数値情報](https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A45.html)
          
          このURLは、MapLibre GLなどのPMTilesをサポートする地図ライブラリで直接利用できます。

          ## 更新履歴
          - $(date +'%Y-%m-%d'): データ更新
          EOF
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # コミットとプッシュを強制的に行う
          git add README.md
          git commit -m "Update PMTiles URL" || echo "No changes to commit"
          git push --force || echo "No changes to push"
